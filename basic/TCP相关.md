#### 计算机五层网络模型

1. 应用层

2. 传输层

3. 网络层

4. 链路层

5. 物理层

   

#### TCP

- 传输协议（传输层）面向连接、可靠的传输协议

  

#### 三次握手四次挥手

- 本质是解决网络信道不可靠的问题，为能在不可靠的信道上建立可靠的连接

  

#### 三次握手

![](../assets/TCP/三次握手.png)

三次握手是用来在客户端与服务器之间建立一个可靠的TCP连接的过程。这个过程通过交换三个报文段来完成：

1. **第一次握手**：客户端向服务器发送一个SYN报文段，**表示希望与服务器建立连接**，并进入SYN_SEND状态。

2. **第二次握手**：服务器接收到客户端的SYN报文后，需要确认客户端的SYN，**如果同意连接，即回复一包SYN+ACK报文**。此时，服务器进入SYN_RECV状态。

3. **第三次握手**：客户端收到服务器的SYN+ACK报文后，**再次对服务器的SYN进行确认，表示能正常接收到数据，发送ACK报文给服务器**。之后，双方都进入ESTABLISHED状态，表示连接已经成功建立，可以开始数据传输。

   

#### 传输过程

TCP中的**序列号**是**TCP报文头部的一个重要字段**，用于**确保数据的可靠传输和顺序重组**，具体作用：

- **数据排序：**TCP它负责将应用层的数据分割成适合网络传输的数据段，并通过IP网络发送出去。在网络传输过程中，这些数据段可能会经过不同的路径到达目的地，**导致乱序**。**接收方通过序列号来重新排列接收到的数据段，以正确的顺序传递给应用层。**
- **流量控制与拥塞控制：**序列号帮助TCP实现**流量控制机制**，通过确认应答（**ACK**）机制，发送方可以知道哪些数据已被成功接收，从而决定**是否需要重发某些数据段**或调整发送速率。
- **丢包检测与恢复：**当发送的数据段丢失时，接收方不会收到对应的序列号范围内的数据，因此无法给出相应的ACK。**发送方根据超时**或其他机制发现丢失的数据段后，会**重新发送丢失的数据**。
- **防止重复数据：**序列号有助于识别并丢弃重复的数据段。如果由于某种原因同一个数据段被多次发送，接收方可以通过检查序列号避免处理重复的数据。

**序列号的工作原理**

- **初始序列号：**在建立TCP连接的过程中（三次握手），每一端都会生成一个初始序列号。这个号码是随机生成的，主要是为了增加安全性，防止预测下一个序列号。

- **序列号递增规则：**每次发送一个字节的数据，序列号就会 +1 。

  例如，如果第一个数据段包含从序列号1000开始的500个字节的数据，则下一个数据段将从1500开始。

- 确认号（**ACK** Number）：接收方使用确认号告知发送方**期望收到的下一个字节的序列号**。这意味着所有小于该确认号的数据都已成功接收。

  

#### 四次挥手

<img src="../assets/TCP/四次挥手.png" style="zoom:80%;" />

四次挥手则是用来**安全地关闭一个已建立的TCP连接**。由于TCP连接是全双工的，这意味着每个方向上的数据流都需要独立关闭，因此需要四个步骤：

1. **第一次挥手**：主动关闭方发送一个FIN（结束标志，Finish），**表示本端不再有数据要发送了，但还可以接收对方的数据**，进入FIN_WAIT_1状态。
2. **第二次挥手**：被动关闭方（通常是服务器）接收到FIN后，**向主动关闭方发送ACK确认信息，表明收到了对方的关闭请求**，但此时被动关闭方可能还有未发送完的数据或未处理完的数据需要继续处理，因此不会立即关闭连接。此时，被动关闭方进入CLOSE_WAIT状态，而主动关闭方则进入FIN_WAIT_2状态。
3. **第三次挥手**：**当被动关闭方完成了所有的数据发送后，它会发送一个FIN给主动关闭方，表明自己也没有更多数据要发送了，并准备关闭连接**。这时，被动关闭方进入LAST_ACK状态。
4. **第四次挥手**：主动关闭方**收到被动关闭方的FIN后，必须给出确认ACK响应**，随后进入TIME_WAIT状态。在这个状态下，主动关闭方等待足够长的时间以确保被动关闭方收到了ACK报文并完全关闭连接。一段时间后，如果没有收到额外的数据包，则主动关闭方也会关闭连接，释放资源。